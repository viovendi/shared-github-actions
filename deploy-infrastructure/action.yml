name: Deploy infrastructure
inputs:
  microservice-name:
    description: Microservice short name
    required: true
  environment:
    description: Environment
    required: true
  cf-stack-name-suffix:
    description: CloudFormation stack name suffix with trailing '-' (e.g. -database)
    required: false
    default: ''
  cf-template-path:
    description: CloudFormation template path in the repository (e.g. ./infrastructure/infrastructure.yml)
    required: false
    default: './infrastructure/infrastructure.yml'
  cf-parameters:
    description: CloudFormation parameters divided by whitespace, Infrastructure parameter should not be specified (e.g. ImageTag=123 CustomParameter=value)
    required: false
    default: ''
runs:
  using: composite
  steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Package infrastructure
      shell: bash
      run: |
        aws cloudformation package \
          --template-file ${{ inputs.cf-template-path }} \
          --s3-bucket doo-infrastructure \
          --s3-prefix ${{ inputs.microservice-name }} \
          --output-template-file ./infrastructure/compiled.yml

    - name: Deploy infrastructure
      shell: bash
      run: |
        aws cloudformation deploy \
          --template-file ./infrastructure/compiled.yml \
          --stack-name ${{ format('{0}-{1}{2}', inputs.microservice-name, inputs.environment, inputs.cf-stack-name-suffix) }} \
          --s3-bucket doo-infrastructure \
          --s3-prefix ${{ inputs.microservice-name }} \
          --parameter-overrides Infrastructure=${{ inputs.environment }} ${{ inputs.cf-parameters }} \
          --capabilities CAPABILITY_IAM
